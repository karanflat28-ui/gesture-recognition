<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nebula Core - Final Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #start-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 40px; background: #00ffff; border: none; cursor: pointer; z-index: 100; font-weight: bold; border-radius: 50px; font-size: 1.2rem; }
        #ui { position: absolute; top: 20px; width: 100%; text-align: center; color: #00ffff; pointer-events: none; }
        .canvas-container { position: absolute; bottom: 10px; left: 10px; width: 160px; height: 120px; border: 2px solid #333; border-radius: 10px; overflow: hidden; }
        video.input_video, canvas.output_canvas { position: absolute; width: 100%; height: 100%; transform: scaleX(-1); }
    </style>
</head>
<body>
    <button id="start-btn">ENGAGE NEBULA</button>
    <div id="ui"><h1 id="status">OFFLINE</h1><p id="debug">Click the button to start camera...</p></div>
    
    <div class="canvas-container">
        <video class="input_video"></video>
        <canvas class="output_canvas"></canvas>
    </div>

  <script>
    let isStarted = false;
    const starCount = 4500;
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const geometry = new THREE.BufferGeometry();
    const pos = new Float32Array(starCount * 3);
    const targets = new Float32Array(starCount * 3);
    const colors = new Float32Array(starCount * 3);

    const colorIdle = new THREE.Color(0x00ffff);
    const colorText = new THREE.Color(0xffd700);
    const colorPuppy = new THREE.Color(0xff69b4);

    // Initial setup
    for (let i = 0; i < starCount; i++) {
        pos[i*3] = (Math.random()-0.5)*50;
        pos[i*3+1] = (Math.random()-0.5)*50;
        pos[i*3+2] = (Math.random()-0.5)*50;
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    const points = new THREE.Points(geometry, new THREE.PointsMaterial({ size: 0.12, vertexColors: true }));
    scene.add(points);
    camera.position.z = 25;

    // --- HIGH-RESOLUTION SHAPES ---

    function setGalaxy() {
        for (let i = 0; i < starCount; i++) {
            const a = (i/starCount) * Math.PI * 25;
            const r = (i/starCount) * 18;
            targets[i*3] = Math.cos(a)*r; 
            targets[i*3+1] = Math.sin(a)*r; 
            targets[i*3+2] = (Math.random()-0.5)*5;
        }
    }

    function setFist() {
        for (let i = 0; i < starCount; i++) {
            targets[i*3] = (Math.random()-0.5)*0.3;
            targets[i*3+1] = (Math.random()-0.5)*0.3;
            targets[i*3+2] = (Math.random()-0.5)*0.3;
        }
    }

    function setPuppy() {
        for (let i = 0; i < starCount; i++) {
            const t = i / starCount;
            if (t < 0.4) { // Main Head (Circle)
                const a = Math.random() * Math.PI * 2;
                const r = Math.random() * 4;
                targets[i*3] = Math.cos(a) * r;
                targets[i*3+1] = Math.sin(a) * r + 2;
            } else if (t < 0.7) { // Long Droopy Ears
                const side = i % 2 === 0 ? 1 : -1;
                targets[i*3] = (side * 4.5) + (Math.random()-0.5);
                targets[i*3+1] = (Math.random() * -6) + 3;
            } else if (t < 0.9) { // The Snout/Muzzle
                targets[i*3] = (Math.random()-0.5) * 3;
                targets[i*3+1] = (Math.random() * 2) - 1;
            } else { // The Tail (Little wiggle)
                targets[i*3] = (Math.random() * 2) - 1;
                targets[i*3+1] = -5 + (Math.random());
            }
            targets[i*3+2] = (Math.random()-0.5)*1;
        }
    }

    function setText() {
        // Mapping stars to 5 horizontal lines to simulate text blocks
        for (let i = 0; i < starCount; i++) {
            const line = Math.floor(i / (starCount / 5));
            targets[i*3] = ( (i % (starCount / 5)) / 150 - 3) * 15; // Width
            targets[i*3+1] = (2 - line) * 3; // Height spacing
            targets[i*3+2] = 0;
        }
    }

    // --- HANDS ENGINE ---
    const videoElement = document.querySelector('.input_video');
    const canvasElement = document.querySelector('.output_canvas');
    const canvasCtx = canvasElement.getContext('2d');

    function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        const status = document.getElementById('status');
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            drawConnectors(canvasCtx, lm, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            
            // Gesture logic
            const index = lm[8].y < lm[6].y;
            const middle = lm[12].y < lm[10].y;
            const ring = lm[16].y < lm[14].y;
            const pinky = lm[20].y < lm[18].y;

            if (index && middle && !ring && !pinky) { status.innerText = "HAVE A GREAT DAY"; setText(); }
            else if (index && pinky && !middle) { status.innerText = "PUPPY MODE"; setPuppy(); }
            else if (!index && !middle && !ring && !pinky) { status.innerText = "SINGULARITY"; setFist(); }
            else { status.innerText = "GALAXY IDLE"; setGalaxy(); }
        } else {
            status.innerText = "GALAXY IDLE"; setGalaxy();
        }
        canvasCtx.restore();
    }

    function animate() {
        requestAnimationFrame(animate);
        const p = geometry.attributes.position.array;
        const c = geometry.attributes.color.array;
        const s = document.getElementById('status').innerText;

        for (let i = 0; i < starCount; i++) {
            let ix=i*3, iy=i*3+1, iz=i*3+2;
            // Movement physics
            p[ix] += (targets[ix]-p[ix])*0.15; 
            p[iy] += (targets[iy]-p[iy])*0.15; 
            p[iz] += (targets[iz]-p[iz])*0.15;
            
            // Color logic
            let col = colorIdle;
            if(s.includes("DAY")) col = colorText;
            if(s.includes("PUPPY")) col = colorPuppy;
            c[ix]+=(col.r-c[ix])*0.1; c[iy]+=(col.g-c[iy])*0.1; c[iz]+=(col.b-c[iz])*0.1;
        }
        geometry.attributes.position.needsUpdate = true;
        geometry.attributes.color.needsUpdate = true;
        points.rotation.z += 0.002;
        renderer.render(scene, camera);
    }

    document.getElementById('start-btn').addEventListener('click', () => {
        isStarted = true;
        document.getElementById('start-btn').style.display = 'none';
        setGalaxy();
        animate();
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.6 });
        hands.onResults(onResults);
        new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        }).start();
    });
</script>
</body>
</html>